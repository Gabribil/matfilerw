/*
 * Code licensed under new-style BSD (see LICENSE).
 * All code up to tags/original: Copyright (c) 2006, Wojciech Gradkowski
 * All code after tags/original: Copyright (c) 2015, DiffPlug
 */
package com.jmatio.io;

import static org.hamcrest.CoreMatchers.equalTo;
import static org.hamcrest.CoreMatchers.instanceOf;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.junit.Assert.assertThat;

import java.io.*;
import java.util.Map;

import org.junit.Rule;
import org.junit.Test;
import org.junit.rules.TemporaryFolder;
import org.junit.runner.RunWith;
import org.junit.runners.JUnit4;

import com.jmatio.types.*;

/** This test verifies that ReducedHeader generated mat files work correctly.
 *
 * @author Matthew Dawson <matthew@mjdsystems.ca>
 */
@RunWith(JUnit4.class)
public class SimulinkMatTest {
	@Rule
	public TemporaryFolder folder = new TemporaryFolder();

	@Test
	public void testParsingQuadraticRootsTET() throws IOException {
		File file = fileFromStream("/simulink_tet_out.mat");
		MatFileReader reader = new MatFileReader(file, new MatFileFilter(), MatFileType.ReducedHeader);
		MLObject data = (MLObject) reader.getContent().get("@");

		// First check that the root element is correct.
		assertThat(data, notNullValue());
		assertThat(data.getClassName(), equalTo("Data"));
		assertThat(data.getSize(), equalTo(1));
		Map<String, MLArray> dataO = data.getFields(0);
		assertThat(dataO.size(), equalTo(10));
		assertThat(((MLChar) dataO.get("function_name")).getString(0), equalTo("quad_fcn_subtype"));
		assertThat(((MLChar) dataO.get("function_inputs")).getString(0), equalTo("c,a,b:{x:real|(a=0 => x /= 0) AND (a /= 0 => (x^2) - 4*a*c >= 0)}"));
		assertThat(((MLDouble) dataO.get("open")).get(0), equalTo(0.0));
		assertThat(((MLDouble) dataO.get("fig")).getSize(), equalTo(0)); // This field should just exist, but be empty!
		assertThat(((MLDouble) dataO.get("multi_mode")).get(0), equalTo(1.0));
		assertThat(((MLDouble) dataO.get("checked")).get(0), equalTo(0.0));

		// Next, make sure the settings structure came out right.  Not super important, but a good test.
		MLStructure settings = (MLStructure) dataO.get("settings");
		assertThat(settings.getAllFields().size(), equalTo(5));
		assertThat(((MLDouble) settings.getField("set")).get(0), equalTo(1.0));
		assertThat((settings.getField("inputs")), instanceOf(MLDouble.class));
		assertThat(((MLDouble) settings.getField("count")).get(0), equalTo(1000.0));
		assertThat(((MLDouble) settings.getField("range")).get(0), equalTo(100.0));
		assertThat(((MLDouble) settings.getField("except")).get(0), equalTo(0.0));

		// Next, verify Grid2, as it is easiest.
		MLObject Grid2 = (MLObject) dataO.get("Grid2");
		assertThat(Grid2.getClassName(), equalTo("Grid"));
		assertThat(Grid2.getSize(), equalTo(1));
		Map<String, MLArray> gridO = Grid2.getFields(0);

		assertThat(((MLDouble) gridO.get("num_cells")).get(0), equalTo(2.0));
		assertThat(gridO.get("split_pb").getSize(), equalTo(0));
		assertThat(gridO.get("parent_grid").getSize(), equalTo(0));
		assertThat(gridO.get("parent_cell").getSize(), equalTo(0));
		assertThat(gridO.get("new_cell_pb").getSize(), equalTo(0));
		assertThat(gridO.get("delete_cell_pb").getSize(), equalTo(0));
		assertThat(((MLObject) gridO.get("rGrid")).getFields(0), equalTo(((MLObject) dataO.get("Grid0")).getFields(0)));
		assertThat(((MLDouble) gridO.get("grid_index")).get(0), equalTo(2.0));

		MLObject cells = (MLObject) gridO.get("cells");
		assertThat(cells.getSize(), equalTo(2));
		Map<String, MLArray> cellO = cells.getFields(0);

		assertThat(((MLChar) cellO.get("cond_text")).getString(0), equalTo("a == 0"));

		assertThat(((MLChar) cells.getFields(1).get("cond_text")).getString(0), equalTo("a ~= 0"));
	}

	// This just ensures the SimulinkDecoder actually decodes correctly.
	@Test
	public void testParsingSimulinkEncoding() throws IOException {
		final int expectedTETSize = 16184;
		String input = "  %)30     .    >     8    (    $0         !          $ ! !-0T]3 0 $ $1A=&$.    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    !    !0    X   \"H/@  !@    @    )          4    (     0   '@^   !          (   !X/@    %)30     .    V#T   8    (     @         %    \"     $    !     0         %  0 !0    $    %    34-/4P     .    D#T   8    (    $0         !          $ ! !-0T]3 0    T   !&:6QE5W)A<'!E<E]?    #@   % ]   &    \"     $         !0    @   !X     0    $         #@   +@+   &    \"     D         !0    @   \"(\"P   0    $          @   (@+   \"    +    -@!   X @  . (  ) $  # \"@  B L             1W)I9#  0V5L;', 0V5L;#$ 8V]N9%]T97AT &-E;&Q?:6YD97@ <&%R96YT7V=R:60 8V5L;', 1W)I9 !P87)E;G1?8V5L; !S<&QI=%]P8@!N=6U?8V5L;', 9W)I9%]I;F1E> !R1W)I9 !N97=?8V5L;%]P8@!D96QE=&5?8V5L;%]P8@!P8E]F;&%G $-E;&P <W5B9W)I9 !C;VYD '=I9'1H &AE:6=H= !G<FED7W!B &-O;&]R &-O;F1I=&EO;E]T97AT7W=I9'1H &-O;F1I=&EO;E]T97AT7VAE:6=H= !C;VYD:71I;VY?=&5X=%]X &-O;F1I=&EO;E]T97AT7WD 8V]N9&ET:6]N7W1E>'1?;V9F<V5T &=R:61?<'5S:%]W:61T: !21W)I9 !'<FED,0!'<FED,@!#96QL,@!R97-U;'1?=&5X= !20V5L; !R97-U;'0 9G5N8W1I;VY?;F%M90!F=6YC=&EO;E]I;G!U=', <V5T=&EN9W, 8VAE8VME9 !O<&5N &UU;'1I7VUO9&4 1&%T80!F:6<                                    (                    $0                   !X                    C                    *P                                              !0                    $    8     P                    (    7    !                     ,    /     @                    0    #     0                    4    \"     @                    8    !     @                    <    .     0                    @    -     @                    D    ,     0                    H    +     @                    L    *     0                    P    )     @                    T    $     @                    X    (     0                    \\    '     @                   !     %     @                   !$    &    !                    !(    0    !                    !,    1    !                    !0    2    !                    !4    3    !                    !8    4    !                    !<    5    !                    !@    6               )     0    $   !L    'P    $   !M    (     $   !N    )0    $   !O    )@    $   !P    )P    $   !Q    *     $   !R    *0    $   !S    *@    $   !T     P    (    !    :0   !\\    !    :@   \"     !    :P    0    #     0    P    A     0   $H    B     0   $L    7     0   $P         !     0    !          4    !     0    8    !    \"@   !     !    \"P         $    !P    $    &    \"P    $    '    #     $    (    #0    $    )          0    $     0    (    %     0    ,    &     0    0    0     0    4         !@    0    !    #0    4    !    #@    8    !    1@   !0    !    1P   !4    !    2    !     !    20         %    \"0    $   !!    !P    $   !\"    \"P    $   !#    #     $   !$    #0    $   !%    !@   !(    !    #P    0    !    $     4    !    $0    8    !    /@   !0    !    /P   !4    !    0          $    !P    $    Z    \"P    $    [    #     $    \\    #0    $    ]          8    2     0   #0    $     0   #4    %     0   #8    &     0   #<    4     0   #@    5     0   #D         !0    D    !    $@    <    !    ,     L    !    ,0    P    !    ,@    T    !    ,P    8    $     0   !,    %     0   !0    &     0   !4    4     0   !8    5     0   !<    0     0   !@         !@   !(    !    *@    0    !    *P    4    !    +     8    !    +0   !0    !    +@   !4    !    +P         %    \"0    $    9    !P    $    F    \"P    $    G    #     $    H    #0    $    I    !@    0    !    &@    4    !    &P    8    !    '    !0    !    '0   !4    !    '@   !     !    'P         &    !     $    @    !0    $    A    !@    $    B    %     $    C    %0    $    D    $     $    E          0    #     0   $T    A     0   $X    B     0   $\\    7     0   %          !     ,    !    40   \"$    !    4@   \"(    !    4P   !<    !    5          $     P    $   !5    (0    $   !6    (@    $   !7    %P    $   !8          0    #     0   %D    A     0   %H    B     0   %L    7     0   %P         !     ,    !    70   \"$    !    7@   \"(    !    7P   !<    !    8          $     P    $   !A    (0    $   !B    (@    $   !C    %P    $   !D          0    #     0   &4    A     0   &8    B     0   &<    7     0   &@                                                                                                                                                                                                                                                                                    .          X    P    !@    @    $          4    (     0    (    !         !   @!X,0  #@   #@    &    \"     8         !0    @    !     0    $         \"0    @           #P/PX    P    !@    @    $          4    (     0    (    !         !   @!X,@  #@   #@    &    \"     8         !0    @    !     0    $         \"0    @             0 X   !(    !@    @    -          4    (    !@    $    !          8    8        W0(    !     0    4    !    #@   #@    &    \"     8         !0    @    !     0    $         \"0    @           #P/PX   !0    !@    @    -          4    (    !P    $    !          8    <        W0(    !     @    0    &     @         .    .     8    (    !@         %    \"     $    !     0         )    \"             ! #@   #@    &    \"     8         !0    @    !     0    $         \"0    @           #P/PX   !(    !@    @    -          4    (    !@    $    !          8    8        W0(    !     0    (    #    #@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !    !0    $    .    .     8    (    !@         %    \"     $    !     0         )    \"            / _#@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !    !     (    .    .     8    (    !          %    \"     $    &     0         0    !@   &(@?CT@,   #@   #@    &    \"     8         !0    @    !     0    $         \"0    @           #P/PX   !(    !@    @    -          4    (    !@    $    !          8    8        W0(    !     0    @    !    #@   #@    &    \"     0         !0    @    !    !@    $         $     8   !A(#T](#    X    X    !@    @    &          4    (     0    $    !          D    (            \\#\\.    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    +     @    X   !(    !@    @    $          4    (     0   !(    !         !     2    *&)>,BD@+2 T*F$J8R ]/2 P        #@   #@    &    \"     8         !0    @    !     0    $         \"0    @           #P/PX   !(    !@    @    -          4    (    !@    $    !          8    8        W0(    !     0    P    !    #@   #@    &    \"     8         !0    @    !     0    $         \"0    @             0 X    X    !@    @    &          4    (     0    $    !          D    (            \\#\\.    .     8    (    !@         %    \"     $    !     0         )    \"            / _#@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !    #@    (    .    ,     8    (    !          %    \"     $    $     0         0  0 8CX], X    X    !@    @    &          4    (     0    $    !          D    (            \\#\\.    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    /     0    X    X    !@    @    &          4    (     0    $    !          D    (            \\#\\.    .     8    (    !@         %    \"     $    !     0         )    \"            / _#@   #@    &    \"     8         !0    @    !     0    $         \"0    @           #P/PX    P    !@    @    $          4    (     0    ,    !         !   P!B/#  #@   #@    &    \"     8         !0    @    !     0    $         \"0    @             0 X   !(    !@    @    -          4    (    !@    $    !          8    8        W0(    !     0    \\    !    #@   #@    &    \"     8         !0    @    !     0    $         \"0    @           #P/PX    X    !@    @    &          4    (     0    $    !          D    (            \\#\\.    .     8    (    !@         %    \"     $    !     0         )    \"            / _#@   %     &    \"     T         !0    @    '     0    $         !@   !P       #= @    $    \"    $    !$    \"          X    X    !@    @    &          4    (     0    $    !          D    (             $ .    .     8    (    !@         %    \"     $    !     0         )    \"             ! #@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !     @    ,    .    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    /     0    X   !(    !@    @    $          4    (     0   !$    !         !     1    *&)>,BD@+2 T*F$J8R ^(#          #@   #@    &    \"     8         !0    @    !     0    $         \"0    @             0 X   !(    !@    @    -          4    (    !@    $    !          8    8        W0(    !     0    P    !    #@   #@    &    \"     8         !0    @    !     0    $         \"0    @           #P/PX    X    !@    @    &          4    (     0    $    !          D    (            !$ .    4     8    (    #0         %    \"     <    !     0         &    '        -T\"     0    (    -    #@    (         #@   #@    &    \"     8         !0    @    !     0    $         \"0    @             0 X    X    !@    @    &          4    (     0    $    !          D    (             $ .    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    \"     P    X   !(    !@    @    -          4    (    !@    $    !          8    8        W0(    !     0    P    !    #@   #@    &    \"     0         !0    @    !    !@    $         $     8   !A('X](#    X    X    !@    @    &          4    (     0    $    !          D    (             $ .    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    *     0    X    X    !@    @    &          4    (     0    $    !          D    (            \\#\\.    .     8    (    !@         %    \"     $    !     0         )    \"            !! #@   %     &    \"     T         !0    @    '     0    $         !@   !P       #= @    $    \"    \"0    L    \"          X    X    !@    @    &          4    (     0    $    !          D    (             $ .    .     8    (    !@         %    \"     $    !     0         )    \"             ! #@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !     @    ,    .    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    *     0    X    X    !@    @    &          4    (     0    $    !          D    (            \\#\\.    .     8    (    !@         %    \"     $    !     0         )    \"            /@_#@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !    \"0    (    .    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    '     @    X    X    !@    @    &          4    (     0    $    !          D    (            \"$ .    .     8    (    !@         %    \"     $    !     0         )    \"            / _#@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !     @    ,    .    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    (     0    X    X    !@    @    &          4    (     0    $    !          D    (             $ .    .     8    (    !@         %    \"     $    !     0         )    \"            / _#@   #@    &    \"     8         !0    @    !     0    $         \"0    @           #P/PX   !(    !@    @    -          4    (    !@    $    !          8    8        W0(    !     0    <    \"    #@   #     &    \"     0         !0    @    !    !     $         $  $ \"UC+V(.    2     8    (    !@         %    \"     $    #     0         )    &            / _        \\#\\       #P/PX   !(    !@    @    -          4    (    !@    $    !          8    8        W0(    !     0    0    \"    #@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !    #0    (    .    .     8    (    !          %    \"     $    &     0         0    !@   \"UB+S(J80  #@   $@    &    \"     8         !0    @    !     P    $         \"0   !@           #P/P       / _        \\#\\.    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    $     @    X   !(    !@    @    -          4    (    !@    $    !          8    8        W0(    !     0   !     \"    #@   %     &    \"     0         !0    @    !    '@    $         $    !X    H+6(@+2!S<7)T*&)>,B M(#0J82IC*2D@+R R*F$   X   !(    !@    @    &          4    (     0    ,    !          D    8            \\#\\       #P/P       / _#@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !    !     (    .    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    1     @    X   !0    !@    @    $          4    (     0   !X    !         !     >    *\"UB(\"L@<W%R=\"AB7C(@+2 T*F$J8RDI(\"\\@,BIA   .    2     8    (    !@         %    \"     $    #     0         )    &            / _        \\#\\       #P/PX   !(    !@    @    -          4    (    !@    $    !          8    8        W0(    !     0    8    \"    #@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !    !P    (    .    ,     8    (    !          %    \"     $    $     0         0  0 +6,O8@X   !(    !@    @    &          4    (     0    ,    !          D    8            \\#\\       #P/P       / _#@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !    !@    (    .    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    -     @    X    X    !@    @    $          4    (     0    8    !         !     &    +6(O,BIA   .    2     8    (    !@         %    \"     $    #     0         )    &            / _        \\#\\       #P/PX   !(    !@    @    -          4    (    !@    $    !          8    8        W0(    !     0    8    \"    #@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !    $     (    .    8     8    (    !          %    \"     $    I     0         0    *0   &,@+R H82H@*\"@M8B M('-Q<G0H8EXR(\"T@-\"IA*F,I*2 O(#(J82DI          X   !(    !@    @    &          4    (     0    ,    !          D    8            \\#\\       #P/P       / _#@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !    !@    (    .    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    1     @    X   !@    !@    @    $          4    (     0   \"D    !         !     I    8R O(\"AA*B H*\"UB(\"L@<W%R=\"AB7C(@+2 T*F$J8RDI(\"\\@,BIA*2D         #@   $@    &    \"     8         !0    @    !     P    $         \"0   !@           #P/P       / _        \\#\\.    :     8    (    #0         %    \"     T    !     0         &    -        -T\"     0    @    #    $@   !,    4    %0   !8    7    &     0         #@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !    !0    $    .    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    *     0    X   !(    !@    @    -          4    (    !@    $    !          8    8        W0(    !     0    (    #    #@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !    !0    $    .    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    *     0    X   !     !@    @    $          4    (     0   !     !         !     0    <75A9%]F8VY?<W5B='EP90X   !X    !@    @    $          4    (     0   $$    !         !    !!    8RQA+&(Z>W@Z<F5A;'PH83TP(#T^('@@+ST@,\"D@04Y$(\"AA(\"\\](# @/3X@*'A>,BD@+2 T*F$J8R ^/2 P*7T         #@   )@!   &    \"     (         !0    @    !     0    $         !0 $  <    !    (P   '-E=     !I;G!U=', 8V]U;G0  ')A;F=E  !E>&-E<'0        .    .     8    (    !@         %    \"     $    !     0         )    \"            / _#@   #     &    \"     8         !0    @               $         \"0         .    .     8    (    !@         %    \"     $    !     0         )    \"           0(] #@   #@    &    \"     8         !0    @    !     0    $         \"0    @           !90 X    X    !@    @    &          4    (     0    $    !          D    (               .    .     8    (    !@         %    \"     $    !     0         )    \"               #@   #@    &    \"     8         !0    @    !     0    $         \"0    @               X    X    !@    @    &          4    (     0    $    !          D    (            \\#\\.    4 X   8    (     0         %    \"     8    !     0         .    .     8    (     @         %    \"     $          0         %  0  0    $         #@   ,@\"   &    \"     (         !0    @    !     0    $         !0 $  \\    !    AP   '!A<F5N=%]C96QL     '!A<F5N=%]G<FED     &-E;&QS             '-P;&ET7W!B         &YU;5]C96QL<P       &=R:61?:6YD97@      ')'<FED             &YE=U]C96QL7W!B     &1E;&5T95]C96QL7W!B   .    ,     8    (    !@         %    \"                0         )          X    P    !@    @    &          4    (               !          D         #@   #     &    \"     8         !0    @               $         \"0         .    ,     8    (    !@         %    \"                0         )          X    X    !@    @    &          4    (     0    $    !          D    (               .    .     8    (    !@         %    \"     $    !     0         )    \"               #@   #     &    \"     8         !0    @               $         \"0         .    ,     8    (    !@         %    \"                0         )          X    P    !@    @    &          4    (               !          D         #@   &@%   &    \"     (         !0    @    !     0    $         !0 $ !8    !    8 $  '-U8F=R:60                   !C;VYD                        8V]N9%]T97AT                 &-E;&Q?:6YD97@               !P87)E;G1?9W)I9               =VED=&@                      &AE:6=H=                     !G<FED7W!B                    <&)?9FQA9P                   &-O;&]R                      !C;VYD:71I;VY?=&5X=%]W:61T:   8V]N9&ET:6]N7W1E>'1?:&5I9VAT &-O;F1I=&EO;E]T97AT7W@       !C;VYD:71I;VY?=&5X=%]Y        8V]N9&ET:6]N7W1E>'1?;V9F<V5T &=R:61?<'5S:%]W:61T:          .    ,     8    (    !@         %    \"                0         )          X    P    !@    @    &          4    (               !          D         #@   #     &    \"     8         !0    @               $         \"0         .    .     8    (    !@         %    \"     $    !     0         )    \"               #@   #     &    \"     8         !0    @               $         \"0         .    .     8    (    !@         %    \"     $    !     0         )    \"               #@   #@    &    \"     8         !0    @    !     0    $         \"0    @               X    P    !@    @    &          4    (               !          D         #@   #@    &    \"     8         !0    @    !     0    $         \"0    @               X    P    !@    @    &          4    (               !          D         #@   #@    &    \"     8         !0    @    !     0    $         \"0    @           !I0 X    X    !@    @    &          4    (     0    $    !          D    (            3D .    .     8    (    !@         %    \"     $    !     0         )    \"            \"1 #@   #@    &    \"     8         !0    @    !     0    $         \"0    @            D0 X    X    !@    @    &          4    (     0    $    !          D    (            -$ .    .     8    (    !@         %    \"     $    !     0         )    \"            #Y #@   /@    &    \"     (         !0    @    !     0    $         !0 $  8    !    $@   $-E;&QS $=R:60Q $=R:60R          X    P    !@    @    &          4    (               !          D         #@   #     &    \"     8         !0    @               $         \"0         .    ,     8    (    !@         %    \"                0         )          X   \"0 0  !@    @    \"          4    (     0    $    !          4 !  ,     0   #P   !#96QL,0        !#96QL,@        !R97-U;'0       !R97-U;'1?=&5X= !C;VQO<@              #@   #     &    \"     8         !0    @               $         \"0         .    ,     8    (    !@         %    \"                0         )          X    P    !@    @    &          4    (               !          D         #@   #     &    \"     8         !0    @               $         \"0         .    ,     8    (    !@         %    \"                0         )          X    ( P  !@    @    \"          4    (     0    $    !          4 !  0     0   *    !'<FED,               1W)I9#$              $=R:60R              !F=6YC=&EO;E]N86UE    9G5N8W1I;VY?:6YP=71S '-E='1I;F=S          !C:&5C:V5D            ;W!E;@               &9I9P                !M=6QT:5]M;V1E        #@   #     &    \"     8         !0    @               $         \"0         .    ,     8    (    !@         %    \"                0         )          X    P    !@    @    &          4    (               !          D         #@   #     &    \"     8         !0    @               $         \"0         .    ,     8    (    !@         %    \"                0         )          X    P    !@    @    &          4    (               !          D         #@   #     &    \"     8         !0    @               $         \"0         .    ,     8    (    !@         %    \"                0         )          X    P    !@    @    &          4    (               !          D         #@   #     &    \"     8         !0    @               $         \"0         .    B     8    (    \"0         %    \"     $   !8     0         \"    6      !24T     #@   $@    &    \"     (         !0    @    !     0    $         !0 $  4    !    !0   $U#3U,     #@         ";
		InputStream decoder = new SimulinkDecoder(input);

		byte[] buf = new byte[expectedTETSize];

		int read = decoder.read(buf);

		assertThat(read, equalTo(expectedTETSize));

		// Verify we are at the end of the stream
		assertThat(decoder.read(), equalTo(-1));

		// Double check that EOF will be re-thrown on each extra call to read.
		assertThat(decoder.read(), equalTo(-1));

		byte[] expectedBuf = new byte[expectedTETSize];
		InputStream finished = SimulinkMatTest.class.getResourceAsStream("/simulink_tet_out.mat");
		// Sanity check, make sure there are no hidden bytes left on the stream, and all bytes have been read in.
		assertThat(finished.read(expectedBuf), equalTo(expectedTETSize));
		assertThat(finished.read(), equalTo(-1));

		assertThat(buf, equalTo(expectedBuf));
		decoder.close();
	}

	// This just ensures the SimulinkDecoder works correctly with MatFileReader.
	@Test
	public void testParsingTETInSimulinkEncoding() throws IOException {
		String input = "  %)30     .    >     8    (    $0         !          $ ! !-0T]3 0 $ $1A=&$.    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    !    !0    X   \"H/@  !@    @    )          4    (     0   '@^   !          (   !X/@    %)30     .    V#T   8    (     @         %    \"     $    !     0         %  0 !0    $    %    34-/4P     .    D#T   8    (    $0         !          $ ! !-0T]3 0    T   !&:6QE5W)A<'!E<E]?    #@   % ]   &    \"     $         !0    @   !X     0    $         #@   +@+   &    \"     D         !0    @   \"(\"P   0    $          @   (@+   \"    +    -@!   X @  . (  ) $  # \"@  B L             1W)I9#  0V5L;', 0V5L;#$ 8V]N9%]T97AT &-E;&Q?:6YD97@ <&%R96YT7V=R:60 8V5L;', 1W)I9 !P87)E;G1?8V5L; !S<&QI=%]P8@!N=6U?8V5L;', 9W)I9%]I;F1E> !R1W)I9 !N97=?8V5L;%]P8@!D96QE=&5?8V5L;%]P8@!P8E]F;&%G $-E;&P <W5B9W)I9 !C;VYD '=I9'1H &AE:6=H= !G<FED7W!B &-O;&]R &-O;F1I=&EO;E]T97AT7W=I9'1H &-O;F1I=&EO;E]T97AT7VAE:6=H= !C;VYD:71I;VY?=&5X=%]X &-O;F1I=&EO;E]T97AT7WD 8V]N9&ET:6]N7W1E>'1?;V9F<V5T &=R:61?<'5S:%]W:61T: !21W)I9 !'<FED,0!'<FED,@!#96QL,@!R97-U;'1?=&5X= !20V5L; !R97-U;'0 9G5N8W1I;VY?;F%M90!F=6YC=&EO;E]I;G!U=', <V5T=&EN9W, 8VAE8VME9 !O<&5N &UU;'1I7VUO9&4 1&%T80!F:6<                                    (                    $0                   !X                    C                    *P                                              !0                    $    8     P                    (    7    !                     ,    /     @                    0    #     0                    4    \"     @                    8    !     @                    <    .     0                    @    -     @                    D    ,     0                    H    +     @                    L    *     0                    P    )     @                    T    $     @                    X    (     0                    \\    '     @                   !     %     @                   !$    &    !                    !(    0    !                    !,    1    !                    !0    2    !                    !4    3    !                    !8    4    !                    !<    5    !                    !@    6               )     0    $   !L    'P    $   !M    (     $   !N    )0    $   !O    )@    $   !P    )P    $   !Q    *     $   !R    *0    $   !S    *@    $   !T     P    (    !    :0   !\\    !    :@   \"     !    :P    0    #     0    P    A     0   $H    B     0   $L    7     0   $P         !     0    !          4    !     0    8    !    \"@   !     !    \"P         $    !P    $    &    \"P    $    '    #     $    (    #0    $    )          0    $     0    (    %     0    ,    &     0    0    0     0    4         !@    0    !    #0    4    !    #@    8    !    1@   !0    !    1P   !4    !    2    !     !    20         %    \"0    $   !!    !P    $   !\"    \"P    $   !#    #     $   !$    #0    $   !%    !@   !(    !    #P    0    !    $     4    !    $0    8    !    /@   !0    !    /P   !4    !    0          $    !P    $    Z    \"P    $    [    #     $    \\    #0    $    ]          8    2     0   #0    $     0   #4    %     0   #8    &     0   #<    4     0   #@    5     0   #D         !0    D    !    $@    <    !    ,     L    !    ,0    P    !    ,@    T    !    ,P    8    $     0   !,    %     0   !0    &     0   !4    4     0   !8    5     0   !<    0     0   !@         !@   !(    !    *@    0    !    *P    4    !    +     8    !    +0   !0    !    +@   !4    !    +P         %    \"0    $    9    !P    $    F    \"P    $    G    #     $    H    #0    $    I    !@    0    !    &@    4    !    &P    8    !    '    !0    !    '0   !4    !    '@   !     !    'P         &    !     $    @    !0    $    A    !@    $    B    %     $    C    %0    $    D    $     $    E          0    #     0   $T    A     0   $X    B     0   $\\    7     0   %          !     ,    !    40   \"$    !    4@   \"(    !    4P   !<    !    5          $     P    $   !5    (0    $   !6    (@    $   !7    %P    $   !8          0    #     0   %D    A     0   %H    B     0   %L    7     0   %P         !     ,    !    70   \"$    !    7@   \"(    !    7P   !<    !    8          $     P    $   !A    (0    $   !B    (@    $   !C    %P    $   !D          0    #     0   &4    A     0   &8    B     0   &<    7     0   &@                                                                                                                                                                                                                                                                                    .          X    P    !@    @    $          4    (     0    (    !         !   @!X,0  #@   #@    &    \"     8         !0    @    !     0    $         \"0    @           #P/PX    P    !@    @    $          4    (     0    (    !         !   @!X,@  #@   #@    &    \"     8         !0    @    !     0    $         \"0    @             0 X   !(    !@    @    -          4    (    !@    $    !          8    8        W0(    !     0    4    !    #@   #@    &    \"     8         !0    @    !     0    $         \"0    @           #P/PX   !0    !@    @    -          4    (    !P    $    !          8    <        W0(    !     @    0    &     @         .    .     8    (    !@         %    \"     $    !     0         )    \"             ! #@   #@    &    \"     8         !0    @    !     0    $         \"0    @           #P/PX   !(    !@    @    -          4    (    !@    $    !          8    8        W0(    !     0    (    #    #@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !    !0    $    .    .     8    (    !@         %    \"     $    !     0         )    \"            / _#@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !    !     (    .    .     8    (    !          %    \"     $    &     0         0    !@   &(@?CT@,   #@   #@    &    \"     8         !0    @    !     0    $         \"0    @           #P/PX   !(    !@    @    -          4    (    !@    $    !          8    8        W0(    !     0    @    !    #@   #@    &    \"     0         !0    @    !    !@    $         $     8   !A(#T](#    X    X    !@    @    &          4    (     0    $    !          D    (            \\#\\.    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    +     @    X   !(    !@    @    $          4    (     0   !(    !         !     2    *&)>,BD@+2 T*F$J8R ]/2 P        #@   #@    &    \"     8         !0    @    !     0    $         \"0    @           #P/PX   !(    !@    @    -          4    (    !@    $    !          8    8        W0(    !     0    P    !    #@   #@    &    \"     8         !0    @    !     0    $         \"0    @             0 X    X    !@    @    &          4    (     0    $    !          D    (            \\#\\.    .     8    (    !@         %    \"     $    !     0         )    \"            / _#@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !    #@    (    .    ,     8    (    !          %    \"     $    $     0         0  0 8CX], X    X    !@    @    &          4    (     0    $    !          D    (            \\#\\.    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    /     0    X    X    !@    @    &          4    (     0    $    !          D    (            \\#\\.    .     8    (    !@         %    \"     $    !     0         )    \"            / _#@   #@    &    \"     8         !0    @    !     0    $         \"0    @           #P/PX    P    !@    @    $          4    (     0    ,    !         !   P!B/#  #@   #@    &    \"     8         !0    @    !     0    $         \"0    @             0 X   !(    !@    @    -          4    (    !@    $    !          8    8        W0(    !     0    \\    !    #@   #@    &    \"     8         !0    @    !     0    $         \"0    @           #P/PX    X    !@    @    &          4    (     0    $    !          D    (            \\#\\.    .     8    (    !@         %    \"     $    !     0         )    \"            / _#@   %     &    \"     T         !0    @    '     0    $         !@   !P       #= @    $    \"    $    !$    \"          X    X    !@    @    &          4    (     0    $    !          D    (             $ .    .     8    (    !@         %    \"     $    !     0         )    \"             ! #@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !     @    ,    .    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    /     0    X   !(    !@    @    $          4    (     0   !$    !         !     1    *&)>,BD@+2 T*F$J8R ^(#          #@   #@    &    \"     8         !0    @    !     0    $         \"0    @             0 X   !(    !@    @    -          4    (    !@    $    !          8    8        W0(    !     0    P    !    #@   #@    &    \"     8         !0    @    !     0    $         \"0    @           #P/PX    X    !@    @    &          4    (     0    $    !          D    (            !$ .    4     8    (    #0         %    \"     <    !     0         &    '        -T\"     0    (    -    #@    (         #@   #@    &    \"     8         !0    @    !     0    $         \"0    @             0 X    X    !@    @    &          4    (     0    $    !          D    (             $ .    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    \"     P    X   !(    !@    @    -          4    (    !@    $    !          8    8        W0(    !     0    P    !    #@   #@    &    \"     0         !0    @    !    !@    $         $     8   !A('X](#    X    X    !@    @    &          4    (     0    $    !          D    (             $ .    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    *     0    X    X    !@    @    &          4    (     0    $    !          D    (            \\#\\.    .     8    (    !@         %    \"     $    !     0         )    \"            !! #@   %     &    \"     T         !0    @    '     0    $         !@   !P       #= @    $    \"    \"0    L    \"          X    X    !@    @    &          4    (     0    $    !          D    (             $ .    .     8    (    !@         %    \"     $    !     0         )    \"             ! #@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !     @    ,    .    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    *     0    X    X    !@    @    &          4    (     0    $    !          D    (            \\#\\.    .     8    (    !@         %    \"     $    !     0         )    \"            /@_#@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !    \"0    (    .    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    '     @    X    X    !@    @    &          4    (     0    $    !          D    (            \"$ .    .     8    (    !@         %    \"     $    !     0         )    \"            / _#@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !     @    ,    .    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    (     0    X    X    !@    @    &          4    (     0    $    !          D    (             $ .    .     8    (    !@         %    \"     $    !     0         )    \"            / _#@   #@    &    \"     8         !0    @    !     0    $         \"0    @           #P/PX   !(    !@    @    -          4    (    !@    $    !          8    8        W0(    !     0    <    \"    #@   #     &    \"     0         !0    @    !    !     $         $  $ \"UC+V(.    2     8    (    !@         %    \"     $    #     0         )    &            / _        \\#\\       #P/PX   !(    !@    @    -          4    (    !@    $    !          8    8        W0(    !     0    0    \"    #@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !    #0    (    .    .     8    (    !          %    \"     $    &     0         0    !@   \"UB+S(J80  #@   $@    &    \"     8         !0    @    !     P    $         \"0   !@           #P/P       / _        \\#\\.    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    $     @    X   !(    !@    @    -          4    (    !@    $    !          8    8        W0(    !     0   !     \"    #@   %     &    \"     0         !0    @    !    '@    $         $    !X    H+6(@+2!S<7)T*&)>,B M(#0J82IC*2D@+R R*F$   X   !(    !@    @    &          4    (     0    ,    !          D    8            \\#\\       #P/P       / _#@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !    !     (    .    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    1     @    X   !0    !@    @    $          4    (     0   !X    !         !     >    *\"UB(\"L@<W%R=\"AB7C(@+2 T*F$J8RDI(\"\\@,BIA   .    2     8    (    !@         %    \"     $    #     0         )    &            / _        \\#\\       #P/PX   !(    !@    @    -          4    (    !@    $    !          8    8        W0(    !     0    8    \"    #@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !    !P    (    .    ,     8    (    !          %    \"     $    $     0         0  0 +6,O8@X   !(    !@    @    &          4    (     0    ,    !          D    8            \\#\\       #P/P       / _#@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !    !@    (    .    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    -     @    X    X    !@    @    $          4    (     0    8    !         !     &    +6(O,BIA   .    2     8    (    !@         %    \"     $    #     0         )    &            / _        \\#\\       #P/PX   !(    !@    @    -          4    (    !@    $    !          8    8        W0(    !     0    8    \"    #@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !    $     (    .    8     8    (    !          %    \"     $    I     0         0    *0   &,@+R H82H@*\"@M8B M('-Q<G0H8EXR(\"T@-\"IA*F,I*2 O(#(J82DI          X   !(    !@    @    &          4    (     0    ,    !          D    8            \\#\\       #P/P       / _#@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !    !@    (    .    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    1     @    X   !@    !@    @    $          4    (     0   \"D    !         !     I    8R O(\"AA*B H*\"UB(\"L@<W%R=\"AB7C(@+2 T*F$J8RDI(\"\\@,BIA*2D         #@   $@    &    \"     8         !0    @    !     P    $         \"0   !@           #P/P       / _        \\#\\.    :     8    (    #0         %    \"     T    !     0         &    -        -T\"     0    @    #    $@   !,    4    %0   !8    7    &     0         #@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !    !0    $    .    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    *     0    X   !(    !@    @    -          4    (    !@    $    !          8    8        W0(    !     0    (    #    #@   $@    &    \"     T         !0    @    &     0    $         !@   !@       #= @    $    !    !0    $    .    2     8    (    #0         %    \"     8    !     0         &    &        -T\"     0    $    *     0    X   !     !@    @    $          4    (     0   !     !         !     0    <75A9%]F8VY?<W5B='EP90X   !X    !@    @    $          4    (     0   $$    !         !    !!    8RQA+&(Z>W@Z<F5A;'PH83TP(#T^('@@+ST@,\"D@04Y$(\"AA(\"\\](# @/3X@*'A>,BD@+2 T*F$J8R ^/2 P*7T         #@   )@!   &    \"     (         !0    @    !     0    $         !0 $  <    !    (P   '-E=     !I;G!U=', 8V]U;G0  ')A;F=E  !E>&-E<'0        .    .     8    (    !@         %    \"     $    !     0         )    \"            / _#@   #     &    \"     8         !0    @               $         \"0         .    .     8    (    !@         %    \"     $    !     0         )    \"           0(] #@   #@    &    \"     8         !0    @    !     0    $         \"0    @           !90 X    X    !@    @    &          4    (     0    $    !          D    (               .    .     8    (    !@         %    \"     $    !     0         )    \"               #@   #@    &    \"     8         !0    @    !     0    $         \"0    @               X    X    !@    @    &          4    (     0    $    !          D    (            \\#\\.    4 X   8    (     0         %    \"     8    !     0         .    .     8    (     @         %    \"     $          0         %  0  0    $         #@   ,@\"   &    \"     (         !0    @    !     0    $         !0 $  \\    !    AP   '!A<F5N=%]C96QL     '!A<F5N=%]G<FED     &-E;&QS             '-P;&ET7W!B         &YU;5]C96QL<P       &=R:61?:6YD97@      ')'<FED             &YE=U]C96QL7W!B     &1E;&5T95]C96QL7W!B   .    ,     8    (    !@         %    \"                0         )          X    P    !@    @    &          4    (               !          D         #@   #     &    \"     8         !0    @               $         \"0         .    ,     8    (    !@         %    \"                0         )          X    X    !@    @    &          4    (     0    $    !          D    (               .    .     8    (    !@         %    \"     $    !     0         )    \"               #@   #     &    \"     8         !0    @               $         \"0         .    ,     8    (    !@         %    \"                0         )          X    P    !@    @    &          4    (               !          D         #@   &@%   &    \"     (         !0    @    !     0    $         !0 $ !8    !    8 $  '-U8F=R:60                   !C;VYD                        8V]N9%]T97AT                 &-E;&Q?:6YD97@               !P87)E;G1?9W)I9               =VED=&@                      &AE:6=H=                     !G<FED7W!B                    <&)?9FQA9P                   &-O;&]R                      !C;VYD:71I;VY?=&5X=%]W:61T:   8V]N9&ET:6]N7W1E>'1?:&5I9VAT &-O;F1I=&EO;E]T97AT7W@       !C;VYD:71I;VY?=&5X=%]Y        8V]N9&ET:6]N7W1E>'1?;V9F<V5T &=R:61?<'5S:%]W:61T:          .    ,     8    (    !@         %    \"                0         )          X    P    !@    @    &          4    (               !          D         #@   #     &    \"     8         !0    @               $         \"0         .    .     8    (    !@         %    \"     $    !     0         )    \"               #@   #     &    \"     8         !0    @               $         \"0         .    .     8    (    !@         %    \"     $    !     0         )    \"               #@   #@    &    \"     8         !0    @    !     0    $         \"0    @               X    P    !@    @    &          4    (               !          D         #@   #@    &    \"     8         !0    @    !     0    $         \"0    @               X    P    !@    @    &          4    (               !          D         #@   #@    &    \"     8         !0    @    !     0    $         \"0    @           !I0 X    X    !@    @    &          4    (     0    $    !          D    (            3D .    .     8    (    !@         %    \"     $    !     0         )    \"            \"1 #@   #@    &    \"     8         !0    @    !     0    $         \"0    @            D0 X    X    !@    @    &          4    (     0    $    !          D    (            -$ .    .     8    (    !@         %    \"     $    !     0         )    \"            #Y #@   /@    &    \"     (         !0    @    !     0    $         !0 $  8    !    $@   $-E;&QS $=R:60Q $=R:60R          X    P    !@    @    &          4    (               !          D         #@   #     &    \"     8         !0    @               $         \"0         .    ,     8    (    !@         %    \"                0         )          X   \"0 0  !@    @    \"          4    (     0    $    !          4 !  ,     0   #P   !#96QL,0        !#96QL,@        !R97-U;'0       !R97-U;'1?=&5X= !C;VQO<@              #@   #     &    \"     8         !0    @               $         \"0         .    ,     8    (    !@         %    \"                0         )          X    P    !@    @    &          4    (               !          D         #@   #     &    \"     8         !0    @               $         \"0         .    ,     8    (    !@         %    \"                0         )          X    ( P  !@    @    \"          4    (     0    $    !          4 !  0     0   *    !'<FED,               1W)I9#$              $=R:60R              !F=6YC=&EO;E]N86UE    9G5N8W1I;VY?:6YP=71S '-E='1I;F=S          !C:&5C:V5D            ;W!E;@               &9I9P                !M=6QT:5]M;V1E        #@   #     &    \"     8         !0    @               $         \"0         .    ,     8    (    !@         %    \"                0         )          X    P    !@    @    &          4    (               !          D         #@   #     &    \"     8         !0    @               $         \"0         .    ,     8    (    !@         %    \"                0         )          X    P    !@    @    &          4    (               !          D         #@   #     &    \"     8         !0    @               $         \"0         .    ,     8    (    !@         %    \"                0         )          X    P    !@    @    &          4    (               !          D         #@   #     &    \"     8         !0    @               $         \"0         .    B     8    (    \"0         %    \"     $   !8     0         \"    6      !24T     #@   $@    &    \"     (         !0    @    !     0    $         !0 $  4    !    !0   $U#3U,     #@         ";
		InputStream decoder = new SimulinkDecoder(input);

		MatFileReader reader = new MatFileReader(decoder, new MatFileFilter(), MatFileType.ReducedHeader);
		MLObject data = (MLObject) reader.getContent().get("@");

		// Just check that the root element is basically correct.
		assertThat(data, notNullValue());
		assertThat(data.getClassName(), equalTo("Data"));
		assertThat(data.getSize(), equalTo(1));
	}

	private File fileFromStream(String location) throws IOException {
		String outname = location.replace("/", "_");
		File f = folder.newFile(outname);
		InputStream stream = SimulinkMatTest.class.getResourceAsStream(location);
		OutputStream fos = new BufferedOutputStream(new FileOutputStream(f));
		byte[] buffer = new byte[1024];
		int read = 0;
		while ((read = stream.read(buffer)) != -1) {
			fos.write(buffer, 0, read);
		}
		fos.flush();
		fos.close();
		return f;
	}
}
